<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Water Quality Rankings ‚Äî Oasis Health Scores</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#0a0a0f;color:#e0e0e0;padding:20px;max-width:1100px;margin:0 auto}
h1{font-size:1.8rem;text-align:center;color:#fff;margin-bottom:4px}
.subtitle{text-align:center;color:#666;font-size:.85rem;margin-bottom:20px}
.controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:16px;align-items:center}
.search{flex:1;min-width:200px;padding:10px 16px;border-radius:10px;border:1px solid #2a2a3e;background:#14141f;color:#fff;font-size:.95rem;outline:none}
.search:focus{border-color:#3b82f6}
.filter-row{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:12px;align-items:center}
.filter-label{font-size:.72rem;color:#555;text-transform:uppercase;letter-spacing:.5px;margin-right:4px}
.filter-btn{padding:5px 12px;border-radius:18px;border:1px solid #2a2a3e;background:#14141f;color:#888;font-size:.75rem;cursor:pointer;transition:.2s;white-space:nowrap}
.filter-btn:hover,.filter-btn.active{background:#1a2a4e;border-color:#3b82f6;color:#60a5fa}
.filter-btn.active.green{background:#0a2e1a;border-color:#22c55e;color:#4ade80}
.stats{display:flex;gap:16px;justify-content:center;margin-bottom:16px;flex-wrap:wrap}
.stat{background:#14141f;border:1px solid #1e1e2e;border-radius:10px;padding:10px 18px;text-align:center}
.stat-num{font-size:1.4rem;font-weight:800;color:#fff}
.stat-label{font-size:.7rem;color:#666;margin-top:2px}
.legend{display:flex;gap:14px;justify-content:center;flex-wrap:wrap;margin-bottom:16px;font-size:.78rem}
.legend-item{display:flex;align-items:center;gap:5px}
.legend-dot{width:10px;height:10px;border-radius:50%}
.results-count{font-size:.8rem;color:#555;margin-bottom:10px}
.grid{display:grid;gap:8px}
.card{background:#14141f;border:1px solid #1e1e2e;border-radius:12px;padding:12px 16px;display:flex;align-items:center;gap:12px;transition:.15s;cursor:pointer}
.card:hover{transform:translateX(3px);border-color:#2a2a4e}
.card.excellent{border-left:3px solid #4ade80}
.card.good{border-left:3px solid #60a5fa}
.card.fair{border-left:3px solid #fbbf24}
.card.poor{border-left:3px solid #f97316}
.card.bad{border-left:3px solid #f87171}
.rank-num{font-size:1rem;font-weight:800;min-width:28px;text-align:center;color:#555}
.product-img{width:42px;height:42px;border-radius:8px;object-fit:cover;flex-shrink:0;background:#1a1a2e}
.product-img.hidden{display:none}
.score-ring{position:relative;width:46px;height:46px;flex-shrink:0}
.score-ring svg{transform:rotate(-90deg)}
.score-ring circle{fill:none;stroke-width:4.5}
.score-ring .bg{stroke:#1e1e2e}
.score-ring .fg{stroke-linecap:round}
.score-num{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);font-size:.85rem;font-weight:800}
.info{flex:1;min-width:0}
.brand-name{font-size:.9rem;font-weight:700;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.tags{display:flex;gap:4px;flex-wrap:wrap;margin-top:4px}
.tag{font-size:.62rem;padding:2px 6px;border-radius:14px;background:#1a1a2e;border:1px solid #2a2a3e;color:#999}
.tag.glass{background:#0a1a2e;border-color:#1a3a5e;color:#60a5fa}
.tag.plastic{background:#2e1a0a;border-color:#5e3a1a;color:#f97316}
.tag.aluminum{background:#1a1a2e;border-color:#3a3a5e;color:#a78bfa}
.tag.carton{background:#1a2e1a;border-color:#2a4e2a;color:#86efac}
.tag.pfas-free{background:#0a2e1a;border-color:#1a5e3a;color:#4ade80}
.tag.pfas-yes{background:#2e0a0a;border-color:#5e1a1a;color:#f87171}
.meta-row{display:flex;gap:10px;margin-top:4px;flex-wrap:wrap}
.meta-item{font-size:.62rem;color:#666}
.meta-item span{color:#999;font-weight:600}
.verdict{text-align:right;min-width:60px}
.verdict-text{font-size:.62rem;text-transform:uppercase;font-weight:700;letter-spacing:.5px}
.verdict-text.excellent{color:#4ade80}
.verdict-text.good{color:#60a5fa}
.verdict-text.fair{color:#fbbf24}
.verdict-text.poor{color:#f97316}
.verdict-text.bad{color:#f87171}
.detail-panel{display:none;background:#0f0f1a;border:1px solid #1e1e2e;border-top:none;border-radius:0 0 12px 12px;padding:14px 18px;margin-top:-8px;margin-bottom:2px}
.detail-panel.open{display:block}
.detail-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(140px,1fr));gap:10px}
.detail-box{background:#14141f;border:1px solid #1e1e2e;border-radius:8px;padding:8px 10px;text-align:center}
.detail-box .val{font-size:1rem;font-weight:700;color:#fff}
.detail-box .lbl{font-size:.65rem;color:#666;margin-top:2px}
.detail-source{font-size:.75rem;color:#888;margin-top:10px;line-height:1.5}
.detail-source strong{color:#bbb}
.detail-section{margin-top:14px}
.detail-section h4{font-size:.78rem;color:#bbb;margin-bottom:8px;border-bottom:1px solid #1e1e2e;padding-bottom:5px}
.contaminant-table{width:100%;border-collapse:collapse;font-size:.72rem}
.contaminant-table th{text-align:left;color:#666;padding:4px 8px;border-bottom:1px solid #1e1e2e;font-weight:600}
.contaminant-table td{padding:4px 8px;border-bottom:1px solid #111;color:#ccc}
.contaminant-table tr:hover{background:#1a1a2e}
.contaminant-table .cat{color:#888;font-size:.65rem}
.contaminant-table .over-limit{color:#f87171;font-weight:700}
.contaminant-table .safe{color:#4ade80}
.contaminant-table .beneficial{color:#60a5fa}
.source-link{display:inline-block;margin:4px 6px 4px 0;padding:4px 10px;background:#1a1a2e;border:1px solid #2a2a3e;border-radius:6px;color:#60a5fa;font-size:.72rem;text-decoration:none;transition:.2s}
.source-link:hover{background:#1a2a4e;border-color:#3b82f6}
.desc-text{font-size:.75rem;color:#888;line-height:1.5;margin-bottom:10px;font-style:italic}
.summary-row{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
.summary-pill{display:flex;align-items:center;gap:6px;padding:6px 14px;background:#14141f;border:1px solid #1e1e2e;border-radius:20px;font-size:.75rem;color:#ccc}
.summary-pill .dot{width:8px;height:8px;border-radius:50%}
.summary-pill .val{font-weight:700}
.ing-card{background:#14141f;border:1px solid #1e1e2e;border-radius:10px;padding:12px 14px;margin-bottom:8px}
.ing-card.over-limit{border-color:#5e1a1a}
.ing-card-header{display:flex;justify-content:space-between;align-items:center}
.ing-card-name{font-weight:700;font-size:.82rem;color:#fff}
.ing-card-amount{font-size:.82rem;font-weight:600;color:#ccc}
.ing-card-cat{font-size:.65rem;color:#666;margin-top:1px}
.ing-card-desc{font-size:.72rem;color:#777;margin-top:6px;line-height:1.4}
.risk-badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:.65rem;font-weight:700}
.risk-badge.danger{background:#3e0a0a;color:#f87171;border:1px solid #5e1a1a}
.risk-badge.warning{background:#3e2e0a;color:#fbbf24;border:1px solid #5e4a1a}
.risk-badge.safe{background:#0a2e1a;color:#4ade80;border:1px solid #1a5e3a}
.mineral-card{background:#14141f;border:1px solid #1a3a1a;border-radius:10px;padding:10px 14px;margin-bottom:6px}
.mineral-card-header{display:flex;justify-content:space-between;align-items:center}
.mineral-card .ing-card-name{color:#86efac}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin:12px 0}
.info-box{background:#14141f;border:1px solid #1e1e2e;border-radius:8px;padding:10px 12px}
.info-box .lbl{font-size:.72rem;font-weight:700;color:#fff}
.info-box .val{font-size:.72rem;color:#888;margin-top:3px}
.empty{text-align:center;color:#555;padding:40px;font-size:.9rem}
.load-more{display:block;width:100%;padding:12px;background:#14141f;border:1px solid #2a2a3e;border-radius:10px;color:#60a5fa;font-size:.85rem;cursor:pointer;text-align:center;margin-top:10px}
.load-more:hover{background:#1a2a4e;border-color:#3b82f6}
.note{background:#14141f;border:1px solid #2a2a3e;border-radius:10px;padding:14px 18px;margin-top:24px;font-size:.8rem;color:#888;line-height:1.6}
.note strong{color:#ccc}
.note a{color:#60a5fa}
.loading{text-align:center;padding:60px;color:#555;font-size:1rem}
@media(max-width:600px){
  body{padding:12px}
  .card{padding:10px 12px;gap:8px}
  .score-ring{width:40px;height:40px}
  .brand-name{font-size:.82rem}
  .controls{flex-direction:column}
  .detail-grid{grid-template-columns:repeat(2,1fr)}
}
</style>
</head>
<body>

<h1>üíß Water Quality Rankings</h1>
<p class="subtitle">Rated by <a href="https://www.oasishealth.app" target="_blank" style="color:#60a5fa;text-decoration:none">Oasis Health</a> lab testing ‚Äî <span id="count-label">Loading...</span></p>

<div class="stats" id="stats"></div>

<div class="legend">
  <div class="legend-item"><div class="legend-dot" style="background:#4ade80"></div> Excellent (90+)</div>
  <div class="legend-item"><div class="legend-dot" style="background:#60a5fa"></div> Good (75-89)</div>
  <div class="legend-item"><div class="legend-dot" style="background:#fbbf24"></div> Fair (60-74)</div>
  <div class="legend-item"><div class="legend-dot" style="background:#f97316"></div> Poor (40-59)</div>
  <div class="legend-item"><div class="legend-dot" style="background:#f87171"></div> Avoid (&lt;40)</div>
</div>

<div class="controls">
  <input type="text" class="search" id="search" placeholder="Search waters...">
</div>

<div class="filter-row" id="type-filters">
  <span class="filter-label">Type</span>
</div>
<div class="filter-row" id="pkg-filters">
  <span class="filter-label">Package</span>
</div>
<div class="filter-row" id="extra-filters">
  <span class="filter-label">Quality</span>
</div>

<div class="results-count" id="results-count"></div>
<div class="grid" id="grid"><div class="loading">Loading water data...</div></div>
<button class="load-more" id="load-more" style="display:none">Load more...</button>

<div class="note">
  <strong>üìä Source:</strong> <a href="https://www.oasishealth.app" target="_blank">Oasis Health app</a> ‚Äî science-backed lab testing. Scores out of 100 for contaminants, packaging, transparency, and source quality.<br>
  <strong>üîë Key:</strong> Glass &gt; Plastic for packaging. PFAS (forever chemicals) are the biggest risk ‚Äî safe limit is 0.1 ppt.<br>
  <strong>üí° Top picks:</strong> Aqua Carpatica (92), Hallstein (91), Hawaii Volcanic (91), Icelandic Glacial glass (90), Gerolsteiner sparkling (82).<br>
  <strong>‚ö†Ô∏è Avoid:</strong> Topo Chico (3.9 ppt PFAS), Perrier (1.7 ppt), Deer Park, Arrowhead.<br>
  <strong>üìÖ Updated:</strong> February 10, 2026 ¬∑ Click any product for details
</div>

<script>
let allData = [];
let filtered = [];
let shown = 0;
const PAGE = 50;
let activeType = 'all';
let activePkg = 'all';
let pfasFreeOnly = false;
let glassOnly = false;
let openId = null;

const typeLabels = {
  bottled_water: 'Bottled Water',
  sparkling_water: 'Sparkling',
  flavored_water: 'Flavored',
  water_gallon: 'Gallon Jug',
  mineral_packets: 'Mineral Packets',
  water_filter: 'Water Filter'
};

function getGrade(s) {
  if (s >= 90) return {g:'excellent',t:'Excellent',c:'#4ade80'};
  if (s >= 75) return {g:'good',t:'Good',c:'#60a5fa'};
  if (s >= 60) return {g:'fair',t:'Fair',c:'#fbbf24'};
  if (s >= 40) return {g:'poor',t:'Poor',c:'#f97316'};
  return {g:'bad',t:'Avoid',c:'#f87171'};
}

function getPkgFromName(name) {
  const n = name.toLowerCase();
  if (n.includes('glass bottle') || n.includes('glass')) return 'glass';
  if (n.includes('plastic bottle') || n.includes('plastic')) return 'plastic';
  if (n.includes('can') || n.includes('aluminum')) return 'aluminum';
  if (n.includes('carton') || n.includes('tetra')) return 'carton';
  if (n.includes('gallon')) return 'plastic';
  return '';
}

function getSourceFromName(name) {
  const n = name.toLowerCase();
  if (n.includes('sparkling') || n.includes('carbonated')) return 'sparkling';
  if (n.includes('still')) return 'still';
  return '';
}

async function init() {
  try {
    const resp = await fetch('data.json?v=' + Date.now());
    allData = await resp.json();
  } catch(e) {
    document.getElementById('grid').innerHTML = '<div class="empty">Failed to load data.</div>';
    return;
  }

  // Enrich with packaging/source from name if not in data
  allData.forEach(d => {
    if (!d.packaging) d.packaging = getPkgFromName(d.name);
    d.sparkle = getSourceFromName(d.name);
  });

  document.getElementById('count-label').textContent = `${allData.length} products rated`;
  document.getElementById('search').placeholder = `Search ${allData.length} waters...`;

  renderStats();
  renderFilters();
  applyFilters();
}

function renderStats() {
  const statsEl = document.getElementById('stats');
  const grades = {excellent:0,good:0,fair:0,poor:0,bad:0};
  allData.forEach(d => grades[getGrade(d.score).g]++);
  statsEl.innerHTML = `
    <div class="stat"><div class="stat-num">${allData.length}</div><div class="stat-label">Products</div></div>
    <div class="stat"><div class="stat-num" style="color:#4ade80">${grades.excellent}</div><div class="stat-label">Excellent</div></div>
    <div class="stat"><div class="stat-num" style="color:#60a5fa">${grades.good}</div><div class="stat-label">Good</div></div>
    <div class="stat"><div class="stat-num" style="color:#fbbf24">${grades.fair}</div><div class="stat-label">Fair</div></div>
    <div class="stat"><div class="stat-num" style="color:#f87171">${grades.poor + grades.bad}</div><div class="stat-label">Poor/Avoid</div></div>
  `;
}

function renderFilters() {
  const types = ['all', ...new Set(allData.map(d => d.type).filter(Boolean))];
  const typeEl = document.getElementById('type-filters');
  typeEl.innerHTML = '<span class="filter-label">Type</span>' + types.map(t =>
    `<button class="filter-btn${activeType===t?' active':''}" data-type="${t}">${t==='all'?'All':typeLabels[t]||t} ${t==='all'?'':('('+allData.filter(d=>d.type===t).length+')')}</button>`
  ).join('');

  const pkgs = ['all','glass','plastic','aluminum','carton'];
  const pkgEl = document.getElementById('pkg-filters');
  pkgEl.innerHTML = '<span class="filter-label">Package</span>' + pkgs.map(p =>
    `<button class="filter-btn${activePkg===p?' active':''}" data-pkg="${p}">${p==='all'?'All':'ü´ô '+p} ${p==='all'?'':('('+allData.filter(d=>d.packaging===p).length+')')}</button>`
  ).join('');

  const extraEl = document.getElementById('extra-filters');
  const pfasCount = allData.filter(d => d.pfas === 'No').length;
  extraEl.innerHTML = `<span class="filter-label">Quality</span>
    <button class="filter-btn${pfasFreeOnly?' active green':''}" data-pfas="toggle">‚úÖ PFAS-Free (${pfasCount})</button>
    <button class="filter-btn${glassOnly?' active green':''}" data-glass="toggle">ü•õ Glass Only</button>`;
}

function applyFilters() {
  const q = document.getElementById('search').value.toLowerCase();
  filtered = allData.filter(d => {
    if (q && !d.name.toLowerCase().includes(q)) return false;
    if (activeType !== 'all' && d.type !== activeType) return false;
    if (activePkg !== 'all' && d.packaging !== activePkg) return false;
    if (pfasFreeOnly && d.pfas !== 'No') return false;
    if (glassOnly && d.packaging !== 'glass') return false;
    return true;
  }).sort((a,b) => b.score - a.score);

  document.getElementById('results-count').textContent = `${filtered.length} result${filtered.length!==1?'s':''}`;
  shown = 0;
  document.getElementById('grid').innerHTML = '';
  openId = null;
  loadMore();
}

const circ = 2 * Math.PI * 19;

function renderCard(w, rank) {
  const {g, t, c} = getGrade(w.score);
  const offset = circ - (w.score / 100) * circ;
  const tags = [];
  if (w.packaging) tags.push(`<span class="tag ${w.packaging}">${w.packaging}</span>`);
  if (w.sparkle === 'sparkling') tags.push('<span class="tag" style="background:#1a0a2e;border-color:#3a1a5e;color:#a78bfa">sparkling</span>');
  if (w.pfas === 'No') tags.push('<span class="tag pfas-free">PFAS-free</span>');
  else if (w.pfas && w.pfas !== 'No') tags.push('<span class="tag pfas-yes">PFAS ‚ö†Ô∏è</span>');

  const metaItems = [];
  if (w.ph != null) metaItems.push(`pH <span>${w.ph}</span>`);
  if (w.tds != null) metaItems.push(`TDS <span>${w.tds}</span>`);
  if (w.fluoride != null) metaItems.push(`F‚Åª <span>${w.fluoride}ppm</span>`);
  const metaHtml = metaItems.length ? `<div class="meta-row">${metaItems.map(m=>`<div class="meta-item">${m}</div>`).join('')}</div>` : '';

  // Quick overview boxes
  const details = [];
  if (w.ph != null) details.push({val: w.ph, lbl: 'pH Level', color: w.ph >= 7 ? '#60a5fa' : '#fbbf24'});
  if (w.tds != null) details.push({val: w.tds + ' ppm', lbl: 'TDS', color: '#fff'});
  if (w.fluoride != null) details.push({val: w.fluoride + ' ppm', lbl: 'Fluoride', color: w.fluoride === 0 ? '#4ade80' : w.fluoride < 0.5 ? '#fbbf24' : '#f87171'});
  if (w.pfas) details.push({val: w.pfas === 'No' ? '‚úÖ None' : '‚ö†Ô∏è ' + w.pfas, lbl: 'PFAS', color: w.pfas === 'No' ? '#4ade80' : '#f87171'});
  if (w.capMaterial) details.push({val: String(w.capMaterial).replace(/_/g, ' '), lbl: 'Cap Material', color: '#999'});
  if (w.filtration && w.filtration !== 'Unknown') details.push({val: String(w.filtration), lbl: 'Filtration', color: '#999'});
  if (w.certifiedNoPlastic === 'true') details.push({val: '‚úÖ Yes', lbl: 'No-Plastic Cert', color: '#4ade80'});
  if (w.isPfasTested) details.push({val: '‚úÖ Tested', lbl: 'PFAS Tested', color: '#4ade80'});
  if (w.isMicroplasticsTested) details.push({val: '‚úÖ Tested', lbl: 'Microplastics', color: '#4ade80'});

  const overviewHtml = details.length ? `<div class="detail-grid">${details.map(d =>
    `<div class="detail-box"><div class="val" style="color:${d.color}">${d.val}</div><div class="lbl">${d.lbl}</div></div>`
  ).join('')}</div>` : '';

  // Description
  const descHtml = w.description ? `<div class="desc-text">${w.description}</div>` : '';

  // Summary row (like Oasis: Lab tested, Contaminants count, Nutrients, Microplastics)
  let summaryHtml = '';
  if (w.scoreBreakdown || w.ingredients) {
    const pills = [];
    // Lab tested
    const labSb = (w.scoreBreakdown || []).find(s => s.id === 'untested_penalty');
    if (labSb) {
      const labTested = labSb.score === 0;
      pills.push(`<div class="summary-pill"><div class="dot" style="background:${labTested ? '#4ade80' : '#f87171'}"></div>Lab tested <span class="val">${labTested ? 'Yes' : 'No'}</span></div>`);
    }
    // Contaminants count
    if (w.contaminantCount != null) {
      const cc = w.contaminantCount;
      const clr = cc === 0 ? '#4ade80' : cc <= 3 ? '#fbbf24' : '#f87171';
      pills.push(`<div class="summary-pill"><div class="dot" style="background:${clr}"></div>Contaminants <span class="val">${cc}</span></div>`);
    }
    // Nutrients
    if (w.nutrientCount != null) {
      pills.push(`<div class="summary-pill"><div class="dot" style="background:#60a5fa"></div>Nutrients <span class="val">${w.nutrientCount}</span></div>`);
    }
    // Microplastics
    const mpSb = (w.scoreBreakdown || []).find(s => s.id === 'microplastics_penalty');
    if (mpSb) {
      const mpTested = mpSb.score === 0 || w.isMicroplasticsTested;
      pills.push(`<div class="summary-pill"><div class="dot" style="background:${w.isMicroplasticsTested ? '#4ade80' : '#666'}"></div>Microplastics <span class="val">${w.isMicroplasticsTested ? 'Tested' : 'No'}</span></div>`);
    }
    summaryHtml = `<div class="summary-row">${pills.join('')}</div>`;
  }

  // Contaminant cards (Oasis style)
  let contaminantsHtml = '';
  let mineralsHtml = '';
  let otherHtml = '';
  if (w.ingredients && w.ingredients.length) {
    const contaminants = w.ingredients.filter(i => i.isContaminant || (i.category && !['Minerals','Other'].includes(i.category)));
    const minerals = w.ingredients.filter(i => i.category === 'Minerals');
    const other = w.ingredients.filter(i => !i.isContaminant && (!i.category || i.category === 'Other'));

    if (contaminants.length) {
      const cards = contaminants.map(i => {
        const amt = i.amount != null ? i.amount : '‚Äî';
        const unit = i.measure || '';
        const overLimit = i.limit != null && i.amount != null && i.amount > i.limit;
        const ratio = (i.limit != null && i.amount != null && i.limit > 0) ? (i.amount / i.limit) : null;
        let badge = '';
        if (overLimit && ratio) badge = `<span class="risk-badge danger">${ratio.toFixed(1)}x limit</span>`;
        else if (i.limit != null && i.amount != null && ratio && ratio > 0.5) badge = `<span class="risk-badge warning">${Math.round(ratio * 100)}% of limit</span>`;
        else if (i.limit != null && i.amount != null) badge = `<span class="risk-badge safe">Within limit</span>`;
        const desc = i.desc ? `<div class="ing-card-desc">${i.desc}</div>` : '';
        return `<div class="ing-card${overLimit ? ' over-limit' : ''}">
          <div class="ing-card-header"><div><div class="ing-card-name">${i.name}</div><div class="ing-card-cat">${i.category || ''}</div></div><div style="text-align:right"><div class="ing-card-amount">${amt} ${unit}</div>${badge}</div></div>
          ${desc}
        </div>`;
      }).join('');
      contaminantsHtml = `<div class="detail-section"><h4>‚ö†Ô∏è Contaminants</h4>${cards}</div>`;
    }

    if (minerals.length) {
      const cards = minerals.map(i => {
        const amt = i.amount != null ? i.amount : '‚Äî';
        const unit = i.measure || '';
        const desc = i.benefits || i.desc || '';
        const descHtml2 = desc ? `<div class="ing-card-desc">${desc.substring(0, 150)}</div>` : '';
        return `<div class="mineral-card"><div class="mineral-card-header"><div><div class="ing-card-name">${i.name}</div></div><div class="ing-card-amount">${amt} ${unit}</div></div>${descHtml2}</div>`;
      }).join('');
      mineralsHtml = `<div class="detail-section"><h4>üíé Ingredients & Minerals</h4>${cards}</div>`;
    }

    if (other.length) {
      const cards = other.map(i => {
        const amt = i.amount != null ? i.amount : '‚Äî';
        const unit = i.measure || '';
        const limitInfo = i.limit != null ? ` (limit: ${i.limit} ${unit})` : '';
        return `<div class="ing-card"><div class="ing-card-header"><div class="ing-card-name">${i.name}</div><div class="ing-card-amount">${amt} ${unit}${limitInfo}</div></div></div>`;
      }).join('');
      otherHtml = `<div class="detail-section"><h4>üìã Other</h4>${cards}</div>`;
    }
  }

  // Info grid (Water source, Treatment, TDS, pH - like Oasis)
  let infoGridHtml = '';
  const infoItems = [];
  if (w.source) infoItems.push({lbl: 'Water Source', val: w.source + (w.waterSource ? ' (' + w.waterSource.replace(/_/g, ' ') + ')' : '')});
  else if (w.waterSource) infoItems.push({lbl: 'Water Source', val: w.waterSource.replace(/_/g, ' ')});
  if (w.treatment && w.treatment !== 'Unknown') infoItems.push({lbl: 'Treatment Process', val: w.treatment});
  if (w.tds != null) infoItems.push({lbl: 'TDS', val: w.tds + ' ppm'});
  if (w.ph != null) infoItems.push({lbl: 'pH', val: String(w.ph)});
  if (infoItems.length) {
    infoGridHtml = `<div class="info-grid">${infoItems.map(i => `<div class="info-box"><div class="lbl">${i.lbl}</div><div class="val">${i.val}</div></div>`).join('')}</div>`;
  }

  // Sources / Lab reports
  let sourcesHtml = '';
  if (w.sources && w.sources.length) {
    const links = w.sources.map(s =>
      `<a href="${s.url}" class="source-link" target="_blank" rel="noopener">üìÑ ${s.label || 'Lab Report'}</a>`
    ).join('');
    sourcesHtml = `<div class="detail-section"><h4>üî¨ Sources</h4>${links}</div>`;
  }

  const hasAnyDetail = details.length || w.scoreBreakdown || (w.ingredients && w.ingredients.length) || (w.sources && w.sources.length) || w.source || w.description;
  const noDataHtml = !hasAnyDetail ? '<div style="color:#555;font-size:.8rem;text-align:center;padding:20px">No detailed data available for this product yet.</div>' : '';

  const imgHtml = w.imageUrl ? `<img class="product-img" src="${w.imageUrl}" alt="" loading="lazy" onerror="this.classList.add('hidden')">` : '';

  return `<div class="card ${g}" data-id="${w.id}" onclick="toggleDetail(${w.id})">
    <div class="rank-num">${rank}</div>
    ${imgHtml}
    <div class="score-ring">
      <svg width="46" height="46" viewBox="0 0 46 46">
        <circle class="bg" cx="23" cy="23" r="19"/>
        <circle class="fg" cx="23" cy="23" r="19" stroke="${c}" stroke-dasharray="${circ}" stroke-dashoffset="${offset}"/>
      </svg>
      <div class="score-num" style="color:${c}">${w.score}</div>
    </div>
    <div class="info">
      <div class="brand-name">${w.name}</div>
      <div class="tags">${tags.join('')}</div>
      ${metaHtml}
    </div>
    <div class="verdict">
      <div class="verdict-text ${g}">${t}</div>
    </div>
  </div>
  <div class="detail-panel" id="detail-${w.id}">
    ${w.imageUrl ? `<div style="text-align:center;margin-bottom:12px"><img src="${w.imageUrl}" alt="${w.name}" style="max-height:140px;border-radius:10px;object-fit:contain" loading="lazy"></div>` : ''}
    ${descHtml}
    ${overviewHtml}
    ${summaryHtml}
    ${contaminantsHtml}
    ${mineralsHtml}
    ${otherHtml}
    ${infoGridHtml}
    ${sourcesHtml}
    ${noDataHtml}
  </div>`;
}

function toggleDetail(id) {
  const panel = document.getElementById('detail-' + id);
  if (!panel) return;
  if (openId === id) {
    panel.classList.remove('open');
    openId = null;
  } else {
    if (openId !== null) {
      const prev = document.getElementById('detail-' + openId);
      if (prev) prev.classList.remove('open');
    }
    panel.classList.add('open');
    openId = id;
  }
}

function loadMore() {
  const grid = document.getElementById('grid');
  const end = Math.min(shown + PAGE, filtered.length);
  let html = '';
  for (let i = shown; i < end; i++) {
    html += renderCard(filtered[i], i + 1);
  }
  grid.insertAdjacentHTML('beforeend', html);
  shown = end;

  const btn = document.getElementById('load-more');
  if (shown < filtered.length) {
    btn.style.display = 'block';
    btn.textContent = `Load more (${shown} of ${filtered.length})`;
  } else {
    btn.style.display = 'none';
  }
}

// Events
document.getElementById('search').addEventListener('input', () => { applyFilters(); renderFilters(); });

document.addEventListener('click', e => {
  const btn = e.target.closest('.filter-btn');
  if (!btn) return;
  if (btn.dataset.type !== undefined) {
    activeType = activeType === btn.dataset.type && btn.dataset.type !== 'all' ? 'all' : btn.dataset.type;
  }
  if (btn.dataset.pkg !== undefined) {
    activePkg = activePkg === btn.dataset.pkg && btn.dataset.pkg !== 'all' ? 'all' : btn.dataset.pkg;
  }
  if (btn.dataset.pfas !== undefined) pfasFreeOnly = !pfasFreeOnly;
  if (btn.dataset.glass !== undefined) glassOnly = !glassOnly;
  renderFilters();
  applyFilters();
});

document.getElementById('load-more').addEventListener('click', loadMore);

init();
</script>
</body>
</html>
